<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>Diabetes Runner | Ù„Ø¹Ø¨Ø© Ø§Ù„ØªÙˆØ¹ÙŠØ© Ø¨Ø§Ù„Ø³ÙƒØ±</title>
  <style>
    html, body { height: 100%; margin: 0; background: #0b1020; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    #game { width: 100%; height: 100%; }
    .hud {
      position: absolute; inset-inline: 0; top: 0; display: grid; grid-template-columns: 1fr auto; gap: .5rem; align-items: start; padding: .75rem; pointer-events: none; }
    .panel { background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); backdrop-filter: blur(6px); color: #e6ecff; border-radius: 16px; padding: .75rem 1rem; box-shadow: 0 8px 24px rgba(0,0,0,.2);}    
    .panel h3 { margin: 0 0 .5rem; font-size: .95rem; font-weight: 700; letter-spacing: .3px; }
    .row { display: flex; align-items: center; gap: .5rem; margin: .25rem 0; }
    .tag { font-size: .75rem; padding: .15rem .5rem; border-radius: 999px; background: rgba(255,255,255,.12); }
    .meter { height: 10px; width: 220px; background: rgba(255,255,255,.12); border-radius: 999px; overflow: hidden; }
    .meter > div { height: 100%; width: 0%; background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444); transition: width .25s ease; }

    .controls { position: absolute; inset-inline: 0; bottom: .75rem; display: flex; justify-content: center; gap: .5rem; pointer-events: none; }
    .btn { pointer-events: auto; user-select: none; border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.08); color: #e6ecff; padding: .6rem .9rem; border-radius: 14px; font-weight: 700; letter-spacing: .3px; box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    .btn:active { transform: translateY(1px); }

    .settings { position: absolute; top: .75rem; inset-inline-end: .75rem; pointer-events: auto; }
    .settings .panel { padding: .5rem .75rem; }
    .settings details { cursor: pointer; }
    .settings summary { list-style: none; }
    .settings summary::-webkit-details-marker { display: none; }
    .small { font-size: .8rem; opacity: .9; }
    .muted { opacity: .7; }
  </style>
</head>
<body>
  <div id="game"></div>
  <div class="hud">
    <div class="panel" style="max-width: 520px;">
      <h3>ğŸ® Diabetes Runner â€” ÙˆÙ„Ø¯ Ø¨ÙŠØ¬Ø±ÙŠ ÙˆÙŠØªØ£Ø«Ø± Ø¨Ø§Ù„Ø£ÙƒÙ„ ÙˆÙ‚ÙŠØ§Ø³ Ø§Ù„Ø³ÙƒØ±</h3>
      <div class="row small"><span class="tag">Ù‡Ø¯ÙÙƒ</span><span>Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø£ÙƒÙ„ Ø§Ù„ØµØ­ÙŠ ÙˆØªØ¬Ù†Ø¨ ØºÙŠØ± Ø§Ù„ØµØ­ÙŠ. Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙƒØ± ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø£Ø®Ø¶Ø± Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Boost.</span></div>
      <div class="row"><span class="tag">Ø§Ù„Ø³ÙƒØ± (mg/dL)</span> <strong id="glucoseText">â€”</strong></div>
      <div class="row"><div class="meter"><div id="glucoseBar"></div></div></div>
      <div class="row small muted"><span class="tag">Ø§Ù„Ø­Ø§Ù„Ø©</span> <span id="statusText">â€¦</span></div>
      <div class="row small muted"><span class="tag">Ù†Ù‚Ø§Ø·</span> <span id="scoreText">0</span></div>
    </div>
    <div class="settings">
      <details class="panel">
        <summary>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª / Bluetooth</summary>
        <div class="small" style="margin-top:.5rem">
          <div class="row"><button id="btnConnect" class="btn">ğŸ”— Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² Ø³ÙƒØ± (BLE)*</button></div>
          <div class="muted">*ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Bluetooth. Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙƒ Ø¬Ù‡Ø§Ø² Ù…Ø¯Ø¹ÙˆÙ…ØŒ Ø§Ø³ØªØ®Ø¯Ù… <strong>Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</strong> Ø¨Ø§Ù„Ø£Ø³ÙÙ„.</div>
          <hr style="border-color: rgba(255,255,255,.12);">
          <div class="row">Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø³ÙƒØ±: <button id="btnSimLow" class="btn">Ù…Ù†Ø®ÙØ¶</button> <button id="btnSimOk" class="btn">Ø·Ø¨ÙŠØ¹ÙŠ</button> <button id="btnSimHigh" class="btn">Ù…Ø±ØªÙØ¹</button></div>
          <div class="row">Ø§Ù†Ø¬Ø±Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ: <label><input type="checkbox" id="driftToggle" checked> Ù…ÙØ¹Ù‘Ù„</label></div>
        </div>
      </details>
    </div>
  </div>
  <div class="controls">
    <button id="btnJump" class="btn">â¤´ï¸ Ù‚ÙØ²</button>
    <button id="btnSlide" class="btn">âŸ‚ Ø§Ù†Ø²Ù„Ø§Ù‚</button>
    <button id="btnPause" class="btn">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù/Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
  </div>

  <!-- Phaser 3 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
  <script>
  ;(() => {
    //////////////////////////////
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
    //////////////////////////////
    const TARGET_GLUCOSE = 110; // Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ØµØ­ÙŠ
    const RANGE_LOW = 80;
    const RANGE_HIGH = 140;

    const world = { speed: 220, maxSpeed: 520, minSpeed: 120 };
    const playerState = { glucose: 110, score: 0, fatigue: 0, alive: true };

    const ui = {
      glucoseText: document.getElementById('glucoseText'),
      glucoseBar: document.getElementById('glucoseBar'),
      statusText: document.getElementById('statusText'),
      scoreText: document.getElementById('scoreText'),
      btnConnect: document.getElementById('btnConnect'),
      btnSimLow: document.getElementById('btnSimLow'),
      btnSimOk: document.getElementById('btnSimOk'),
      btnSimHigh: document.getElementById('btnSimHigh'),
      driftToggle: document.getElementById('driftToggle'),
      btnJump: document.getElementById('btnJump'),
      btnSlide: document.getElementById('btnSlide'),
      btnPause: document.getElementById('btnPause'),
    };

    //////////////////////////////
    // Ù„Ø¹Ø¨Ø© Phaser
    //////////////////////////////
    const config = {
      type: Phaser.AUTO,
      parent: 'game',
      width: window.innerWidth,
      height: window.innerHeight,
      physics: { default: 'arcade', arcade: { gravity: { y: 1200 }, debug: false } },
      backgroundColor: '#0b1020',
      scene: { preload, create, update, extend: { spawnItem, spawnObstacle, applyGlucoseEffects } }
    };

    let game = new Phaser.Game(config);

    window.addEventListener('resize', () => {
      game.scale.resize(window.innerWidth, window.innerHeight);
    });

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø´Ù‡Ø¯
    let player, ground, groupFoods, groupBadFoods, groupObstacles, bgLayer, particles, pauseOverlay;
    let cursors;

    function preload() {
      // Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… ØµÙˆØ± Ø®Ø§Ø±Ø¬ÙŠØ© â€” Ù†Ø±Ø³Ù… Ø£Ø´ÙƒØ§Ù„Ù‹Ø§ Ù…ØªØ¬Ù‡Ø©
    }

    function create() {
      const w = this.scale.width, h = this.scale.height;

      // Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø© (Ù†Ø¬ÙˆÙ…)
      bgLayer = this.add.tileSprite(0, 0, w, h, null).setOrigin(0);
      const g = this.add.graphics();
      g.fillStyle(0x0f1736, 1); g.fillRect(0, 0, w, h);
      g.generateTexture('bg', w, h);
      bgLayer.setTexture('bg');

      // Ø§Ù„Ø£Ø±Ø¶
      const groundH = 64;
      const gg = this.add.graphics();
      gg.fillStyle(0x14214a, 1); gg.fillRect(0, 0, w, groundH);
      gg.generateTexture('ground', w, groundH);
      ground = this.physics.add.staticImage(w/2, h - groundH/2, 'ground').setDepth(5);

      // Ø§Ù„Ù„Ø§Ø¹Ø¨ (ÙˆÙ„Ø¯) â€” Ø¬Ø³Ù… Ø¨Ø³ÙŠØ· + ØªØºÙŠÙŠØ± Ø­Ø¬Ù…/Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„ØµØ­Ø©
      const pg = this.add.graphics();
      pg.fillStyle(0x6ee7b7, 1); pg.fillRoundedRect(0, 0, 44, 56, 10);
      pg.generateTexture('playerTex', 44, 56);
      player = this.physics.add.sprite(160, h - groundH - 28, 'playerTex').setDepth(10);
      player.setCollideWorldBounds(true);

      // Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ±
      groupFoods = this.physics.add.group();
      groupBadFoods = this.physics.add.group();
      groupObstacles = this.physics.add.group();

      // Ø§ØµØ·Ø¯Ø§Ù…Ø§Øª
      this.physics.add.collider(player, ground);
      this.physics.add.collider(groupFoods, ground);
      this.physics.add.collider(groupBadFoods, ground);
      this.physics.add.collider(groupObstacles, ground);

      // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
      this.physics.add.overlap(player, groupFoods, (pl, item) => {
        item.destroy();
        playerState.score += 5;
        // Ø§Ù„Ø£ÙƒÙ„ Ø§Ù„ØµØ­ÙŠ ÙŠÙ‚Ø±Ø¨ Ø§Ù„Ø³ÙƒØ± Ù…Ù† Ø§Ù„Ù‡Ø¯Ù
        playerState.glucose = lerp(playerState.glucose, TARGET_GLUCOSE, 0.5);
        this.applyGlucoseEffects();
        pulseTint(player, 0x22c55e);
      });

      this.physics.add.overlap(player, groupBadFoods, (pl, item) => {
        item.destroy();
        playerState.score = Math.max(0, playerState.score - 2);
        // ØºÙŠØ± Ø§Ù„ØµØ­ÙŠ ÙŠØ±ÙØ¹ Ø£Ùˆ ÙŠØ®ÙØ¶ Ø¹Ø´ÙˆØ§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹ÙŠØ¯Ù‹Ø§ Ø¹Ù† Ø§Ù„Ù‡Ø¯Ù
        const delta = Phaser.Math.Between(10, 25) * (Math.random() > 0.5 ? 1 : -1);
        playerState.glucose = clamp(playerState.glucose + delta, 50, 300);
        this.applyGlucoseEffects();
        pulseTint(player, 0xef4444);
      });

      this.physics.add.overlap(player, groupObstacles, (pl, obs) => {
        // Ø¹Ù‚Ø¨Ø©: ÙÙ‚Ø¯Ø§Ù† Ø·Ø§Ù‚Ø© ÙˆØ­Ø±ÙƒØ©
        obs.destroy();
        playerState.fatigue = Math.min(1, playerState.fatigue + 0.15);
        world.speed = Math.max(world.minSpeed, world.speed - 40);
        pulseTint(player, 0xf59e0b);
      });

      // Ù…Ø¤Ø«Ø±Ø§Øª Ø¬Ø³ÙŠÙ…Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ø±ÙŠ
      particles = this.add.particles(0xffffff);
      const trail = particles.createEmitter({
        speed: { min: -40, max: -120 },
        angle: 180,
        lifespan: 500,
        alpha: { start: 0.6, end: 0 },
        scale: { start: 0.8, end: 0.1 },
        frequency: 60,
        follow: player,
        followOffset: { x: -18, y: 24 }
      });

      // Ø¥Ø¯Ø®Ø§Ù„
      cursors = this.input.keyboard.createCursorKeys();
      this.input.keyboard.on('keydown-SPACE', jump);
      this.input.on('pointerdown', jump);
      ui.btnJump.addEventListener('click', jump);
      ui.btnSlide.addEventListener('click', slide);
      ui.btnPause.addEventListener('click', () => { this.scene.isPaused() ? this.scene.resume() : this.scene.pause(); });

      // Timers: ØªÙˆÙ„ÙŠØ¯ Ø¹Ù†Ø§ØµØ±
      this.time.addEvent({ delay: 950, loop: true, callback: () => spawnItem.call(this) });
      this.time.addEvent({ delay: 1450, loop: true, callback: () => spawnObstacle.call(this) });

      // Ø·Ø¨Ù‚Ø© Ø¥ÙŠÙ‚Ø§Ù
      pauseOverlay = this.add.text(w/2, h/2, 'Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªÙ‹Ø§', { fontSize: '28px', color: '#e6ecff' }).setOrigin(0.5).setAlpha(0);
      this.events.on('pause', () => pauseOverlay.setAlpha(0.95));
      this.events.on('resume', () => pauseOverlay.setAlpha(0));

      // Ø¨Ø¯Ø¡ Ø§Ù„Ù‚ÙŠÙ…
      this.applyGlucoseEffects();
      updateHUD();

      // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù†Ø¬Ø±Ø§Ù Ø§Ù„Ø³ÙƒØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ
      this.time.addEvent({ delay: 2000, loop: true, callback: () => {
        if (!ui.driftToggle.checked) return;
        // ÙŠÙ…ÙŠÙ„ Ù†Ø­Ùˆ Ø§Ù„Ù‡Ø¯Ù Ù…Ø¹ Ø¶ÙˆØ¶Ø§Ø¡ Ø®ÙÙŠÙØ©
        playerState.glucose = lerp(playerState.glucose, TARGET_GLUCOSE, 0.05) + Phaser.Math.Between(-3,3);
        playerState.glucose = clamp(playerState.glucose, 50, 300);
        this.applyGlucoseEffects();
      }});

      // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
      ui.btnSimLow.onclick = () => { playerState.glucose = 65; this.applyGlucoseEffects(); };
      ui.btnSimOk.onclick = () => { playerState.glucose = 105; this.applyGlucoseEffects(); };
      ui.btnSimHigh.onclick = () => { playerState.glucose = 210; this.applyGlucoseEffects(); };

      // Ø²Ø± Ø§Ù„Ø§ØªØµØ§Ù„ (ØªØ¬Ø±ÙŠØ¨ÙŠ)
      ui.btnConnect.onclick = async () => {
        try {
          // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ­ØªØ§Ø¬ HTTPS ÙˆÙ…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… Web Bluetooth.
          // Ø£Ø¯Ù†Ø§Ù‡ Ø§Ø³ØªÙƒØ´Ø§Ù Ø¹Ø§Ù…. ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ service/characteristic Ø¨Ù‚ÙŠÙ… Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ.
          const serviceUUID = 0x1808; // Glucose Service (Ù‚ÙŠØ§Ø³ÙŠ)
          const characteristicUUID = 0x2A18; // Glucose Measurement (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©/Ø§Ù„Ø¥Ø®Ø·Ø§Ø±)
          const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [serviceUUID] }],
            optionalServices: [serviceUUID]
          });
          const server = await device.gatt.connect();
          const service = await server.getPrimaryService(serviceUUID);
          const ch = await service.getCharacteristic(characteristicUUID);
          await ch.startNotifications();
          ch.addEventListener('characteristicvaluechanged', (ev) => {
            const dv = ev.target.value; // DataView
            // âš ï¸ ÙÙƒ Ø§Ù„ØªØ±Ù…ÙŠØ² Ø§Ù„ÙØ¹Ù„ÙŠ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ø¬Ù‡Ø§Ø².
            // Ù‡Ù†Ø§ Ù‚Ø±Ø§Ø¡Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: Ù†Ø£Ø®Ø° Ø¨Ø§ÙŠØªÙ‹Ø§ ÙƒÙ…Ø«Ø§Ù„ ÙˆÙ†Ø­ÙˆÙ‘Ù„Ù‡ Ù„Ù‚ÙŠÙ…Ø© Ø±Ù…Ø²ÙŠØ©.
            const raw = dv.getUint8(1) || 100; // Ù…Ø¬Ø±Ø¯ Ù…Ø«Ø§Ù„
            // Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ mg/dL Ù†Ø·Ø§Ù‚ Ù…Ø¹Ù‚ÙˆÙ„
            const mgdl = clamp(50 + raw, 50, 300);
            playerState.glucose = mgdl;
            this.applyGlucoseEffects();
          });
          toast(this, 'âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² â€” ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        } catch (e) {
          console.warn(e);
          toast(this, 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Web Bluetooth â€” Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø£Ùˆ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª');
        }
      };
    }

    function update(time, delta) {
      if (!playerState.alive) return;

      // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„Ø£Ø±Ø¶
      bgLayer.tilePositionX += (world.speed * delta/1000) * 0.2;

      // Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù†Ø­Ùˆ Ø§Ù„ÙŠØ³Ø§Ø±
      const vx = -world.speed;
      [...groupFoods.getChildren(), ...groupBadFoods.getChildren(), ...groupObstacles.getChildren()].forEach(o => o.setVelocityX(vx));

      // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ¹Ø¨ ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§
      playerState.fatigue = Math.max(0, playerState.fatigue - delta/1000 * 0.1);

      // ØªØ­Ø¯ÙŠØ« HUD Ø®ÙÙŠÙ
      if (time % 150 < 16) updateHUD();

      // ØªØ¹Ø¨ÙŠØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø­Ø¬Ù…/Ù„ÙˆÙ†)
      const scale = Phaser.Math.Clamp(1 + (getFitnessFactor() - 0.5) * 0.6, 0.75, 1.35);
      player.setScale(scale);
    }

    //////////////////////////////
    // Ù…ÙˆÙ„Ø¯Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ±
    //////////////////////////////
    function spawnItem() {
      const h = this.scale.height; const y = Phaser.Math.Between(h - 240, h - 120);
      const isHealthy = Math.random() > 0.45; // 55% ØµØ­ÙŠ
      const g = this.add.graphics();
      const size = isHealthy ? 26 : 22;
      if (isHealthy) {
        // ØªÙØ§Ø­Ø© Ø®Ø¶Ø±Ø§Ø¡
        g.fillStyle(0x22c55e, 1); g.fillCircle(size, size, size);
        g.fillStyle(0x166534, 1); g.fillRect(size-2, size-22, 4, 10);
        g.generateTexture('apple'+Date.now(), size*2, size*2);
      } else {
        // ØµÙˆØ¯Ø§ Ø­Ù…Ø±Ø§Ø¡
        g.fillStyle(0xef4444, 1); g.fillRoundedRect(0, 0, size*1.5, size*2, 6);
        g.fillStyle(0xffffff, .9); g.fillRect(4, size*1.1, size*1.5-8, 6);
        g.generateTexture('soda'+Date.now(), size*1.5, size*2);
      }
      const key = g.defaultTextureKey;
      const item = this.physics.add.sprite(this.scale.width + 40, y, key).setDepth(8);
      isHealthy ? groupFoods.add(item) : groupBadFoods.add(item);
      item.setVelocityX(-world.speed);
      item.body.setAllowGravity(false);
      // ØªÙ†Ø¸ÙŠÙ
      item.setData('cleanup', this.time.delayedCall(8000, () => item.destroy()));
    }

    function spawnObstacle() {
      const h = this.scale.height; const y = h - 64 - 18;
      const w = Phaser.Math.Between(24, 48), hh = Phaser.Math.Between(28, 44);
      const g = this.add.graphics();
      g.fillStyle(0xf59e0b, 1); g.fillRoundedRect(0, 0, w, hh, 6);
      g.generateTexture('ob'+Date.now(), w, hh);
      const ob = this.physics.add.sprite(this.scale.width + 40, y - (hh/2), g.defaultTextureKey).setDepth(7);
      groupObstacles.add(ob);
      ob.setVelocityX(-world.speed);
      ob.setImmovable(true);
    }

    //////////////////////////////
    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³ÙƒØ± ÙˆØªØ£Ø«ÙŠØ±Ø§ØªÙ‡
    //////////////////////////////
    function applyGlucoseEffects() {
      // Ø§Ù„Ø³Ø±Ø¹Ø©/Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³ÙƒØ±
      const g = playerState.glucose;
      if (g < RANGE_LOW) {
        world.speed = lerp(world.speed, 0.85 * world.maxSpeed, 0.08); // Ø¨Ø·ÙŠØ¡
        ui.statusText.textContent = 'Ù…Ù†Ø®ÙØ¶ â€” ØªÙ†Ø§ÙˆÙ„ ÙˆØ¬Ø¨Ø© Ø®ÙÙŠÙØ© ØµØ­ÙŠØ©';
      } else if (g > RANGE_HIGH) {
        world.speed = lerp(world.speed, 0.9 * world.minSpeed, 0.1); // Ø£Ø¨Ø·Ø£
        ui.statusText.textContent = 'Ù…Ø±ØªÙØ¹ â€” ØªØ¬Ù†Ø¨ Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª ÙˆÙˆØ§ØµÙ„ Ø§Ù„Ø­Ø±ÙƒØ©';
      } else {
        world.speed = lerp(world.speed, 0.75 * world.maxSpeed, 0.15); // Boost
        ui.statusText.textContent = 'Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ â€” Boost Ù†Ø´Ø·!';
      }
      updateHUD();
    }

    //////////////////////////////
    // ØªØ­ÙƒÙ… Ø§Ù„Ù„Ø§Ø¹Ø¨
    //////////////////////////////
    function jump() {
      if (!player.body) return;
      if (player.body.touching.down) {
        player.setVelocityY(-520);
      }
    }
    function slide() {
      if (!player.body) return;
      // Ø§Ù†ÙƒÙ…Ø§Ø´ Ù…Ø¤Ù‚Øª Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø§Ù†Ø²Ù„Ø§Ù‚
      const oldScale = player.scaleX;
      player.setScale(oldScale, oldScale*0.7);
      setTimeout(() => player.setScale(oldScale), 300);
    }

    //////////////////////////////
    // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆÙˆØ§Ø¬Ù‡Ø©
    //////////////////////////////
    function updateHUD() {
      ui.glucoseText.textContent = Math.round(playerState.glucose);
      const pct = Phaser.Math.Clamp((playerState.glucose - 50) / (300 - 50), 0, 1) * 100;
      ui.glucoseBar.style.width = pct + '%';
      ui.scoreText.textContent = playerState.score;
      // Ù„ÙˆÙ† Ø§Ù„Ø´Ø±ÙŠØ· Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¥Ø²Ø§Ø­Ø© CSS (Ù†ÙØ³ Ø§Ù„ØªØ¯Ø±Ø¬ Ù„ÙƒÙ† Ø§Ù„Ø­Ø±ÙƒØ© ØªØ¹Ø·ÙŠ Ø§Ù†Ø·Ø¨Ø§Ø¹Ù‹Ø§ Ù…Ø®ØªÙ„ÙÙ‹Ø§)
      const hueShift = (playerState.glucose < RANGE_LOW) ? 0 : (playerState.glucose > RANGE_HIGH ? 100 : 50);
      ui.glucoseBar.style.filter = `hue-rotate(${hueShift}deg)`;
    }

    function pulseTint(sprite, color) {
      sprite.setTint(color);
      setTimeout(() => sprite.clearTint(), 180);
    }

    function toast(scene, text) {
      const t = scene.add.text(scene.scale.width/2, 80, text, { fontSize: '16px', color: '#e6ecff', backgroundColor: 'rgba(0,0,0,.35)', padding: {x:10,y:6} }).setOrigin(0.5).setDepth(100);
      scene.tweens.add({ targets: t, alpha: 0, y: 40, duration: 1600, ease: 'Sine.easeOut', onComplete: () => t.destroy() });
    }

    function getFitnessFactor() {
      // 0..1 â€” Ø£Ø¹Ù„Ù‰ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ØµØ­ÙŠ
      const g = playerState.glucose;
      if (g < RANGE_LOW) return 0.45;
      if (g > RANGE_HIGH) return 0.35;
      return 0.9;
    }

    // Math helpers
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
    function lerp(a,b,t){ return a + (b - a) * t; }
  })();
  </script>
</body>
</html>
